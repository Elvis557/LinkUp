<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IO Chat - Real Time</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            margin-top: 30px;
            background-color: #f0f2f5;
            transition: background-color 0.3s ease;
        }
        body.dark-mode {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        #chat {
            height: 450px;
            overflow-y: scroll;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            padding: 15px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        body.dark-mode #chat {
            background-color: #2d2d2d;
            border-color: #444;
            color: #e0e0e0;
        }
        .well {
            padding: 15px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        body.dark-mode .well {
            background-color: #2d2d2d;
            border-color: #444;
        }
        .message-box {
            padding: 10px 15px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            animation: slideIn 0.3s ease;
            transition: all 0.3s ease;
        }
        body.dark-mode .message-box {
            background-color: #3a3a3a;
            color: #e0e0e0;
        }
        .mention {
            background-color: #e3f2fd;
            color: #1976d2;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        body.dark-mode .mention {
            background-color: #1565c0;
            color: #fff;
        }
        .user-item {
            cursor: pointer;
            transition: background 0.2s;
        }
        .user-item:hover {
            background-color: #f0f0f0;
        }
        body.dark-mode .user-item:hover {
            background-color: #3a3a3a;
        }
        .system-message {
            padding: 8px 15px;
            margin-bottom: 10px;
            background-color: #fff3cd;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            color: #856404;
            font-style: italic;
            text-align: center;
            animation: slideIn 0.3s ease;
        }
        .timestamp {
            font-size: 0.75em;
            color: #6c757d;
            margin-left: 10px;
        }
        .typing-indicator {
            padding: 8px 15px;
            color: #6c757d;
            font-style: italic;
            animation: pulse 1.5s infinite;
        }
        .online-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #28a745;
            border-radius: 50%;
            margin-right: 5px;
            animation: blink 2s infinite;
        }
        .notification-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideInRight 0.5s ease;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .read-receipt {
            font-size: 0.7em;
            color: #007bff;
            margin-left: 5px;
        }
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            margin: -15px -15px 15px -15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-md-4">
                <div class="well">
                    <h3>üü¢ Online Users (<span id="user-count">0</span>)</h3>
                    <ul class="list-group" id="users"></ul>
                </div>
            </div>
            <div class="col-md-8">
                <div class="well">
                    <div class="chat-header">
                        <h2>üí¨ Real-Time Chat Room</h2>
                    </div>
                    <div id="chat"></div>
                    <div id="typing-indicator" class="typing-indicator"></div>
                    <form id="messageform">
                        <div class="form-group">
                            <label>Enter Message</label>
                            <textarea id="message" class="form-control" rows="3" placeholder="Type your message..."></textarea>
                        </div><br>
                        <input type="submit" class="btn btn-primary btn-lg w-100" value="üì§ Send Message">
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification Sound -->
    <audio id="notification-sound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGmi77eWeTRAMUKfj8LZjHAU7k9nyz3osBSh+zPDcjj4IFmS56OmkUBELTKXh8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8bllHAU2jdXy0H0tBSh9y/DajDwHF2e56eanUhEKTKPg8Q==" type="audio/wav">
    </audio>
    
    <script>
        $(function(){
            var socket = io.connect("https://real-chat-application-5dxq.onrender.com");
            var $messageForm = $('#messageform');
            var $message = $('#message');
            var $chat = $('#chat');
            var $usersList = $('#users');
            var $typingIndicator = $('#typing-indicator');
            var $userCount = $('#user-count');
            var typingTimer;
            var isTyping = false;
            
            // Request notification permission
            if ("Notification" in window && Notification.permission === "default") {
                Notification.requestPermission();
            }
            
            // Prompt for username when page loads
            var username = prompt("Enter your name:");
            while(!username) {
                username = prompt("Please enter a valid name:");
            }
            
            // Send username to server when connected
            socket.on('connect', function(){
                socket.emit('new user', username, function(data){
                    if(data){
                        console.log("Connected as: " + username);
                        showNotificationBadge("‚úÖ Connected to chat!", "success");
                    }
                });
            });
            
            // Update online users list
            socket.on('get users', function(data){
                var html = '';
                for(var i = 0; i < data.length; i++){
                    html += '<li class="list-group-item user-item" data-username="' + data[i] + '"><span class="online-indicator"></span>' + data[i] + '</li>';
                }
                $usersList.html(html);
                $userCount.text(data.length);
            });
            
            // User joined notification
            socket.on('user joined', function(data){
                $chat.append('<div class="system-message">‚ú® ' + data.user + ' joined the chat <span class="timestamp">' + data.timestamp + '</span></div>');
                scrollToBottom();
                playNotificationSound();
                showDesktopNotification(data.user + " joined", "User joined the chat");
                showNotificationBadge("üëã " + data.user + " joined!", "info");
            });
            
            // User left notification
            socket.on('user left', function(data){
                $chat.append('<div class="system-message">üëã ' + data.user + ' left the chat <span class="timestamp">' + data.timestamp + '</span></div>');
                scrollToBottom();
            });
            
            // Send message when form submitted
            $messageForm.submit(function(e){
                e.preventDefault();
                var msg = $message.val().trim();
                if(msg) {
                    socket.emit('send message', msg);
                    socket.emit('stop typing');
                    isTyping = false;
                    $message.val('');
                }
            });
            
            // Send message with Enter key (Shift+Enter for new line)
            $message.keypress(function(e){
                if(e.which == 13 && !e.shiftKey) {
                    e.preventDefault();
                    $messageForm.submit();
                }
            });
            
            // Typing indicator
            $message.on('input', function(){
                if(!isTyping) {
                    socket.emit('typing');
                    isTyping = true;
                }
                clearTimeout(typingTimer);
                typingTimer = setTimeout(function(){
                    socket.emit('stop typing');
                    isTyping = false;
                }, 1000);
            });
            
            // Show typing indicator
            socket.on('typing', function(data){
                $typingIndicator.html('‚úçÔ∏è ' + data.user + ' is typing...');
            });
            
            // Hide typing indicator
            socket.on('stop typing', function(data){
                $typingIndicator.html('');
            });
            
            // Receive and display new message
            socket.on('new message', function(data){
                var messageClass = data.user === username ? 'message-box' : 'message-box';
                var messageText = highlightMentions(data.msg);
                $chat.append('<div class="' + messageClass + '"><strong>' + data.user + '</strong>: ' + messageText + '<span class="timestamp">' + data.timestamp + '</span><span class="read-receipt">‚úì‚úì</span></div>');
                scrollToBottom();
                
                // Check if current user was mentioned
                if(data.msg.includes('@' + username) && data.user !== username) {
                    playNotificationSound();
                    showDesktopNotification(data.user + " mentioned you", data.msg);
                    showNotificationBadge("üì¢ " + data.user + " mentioned you!", "info");
                }
                // Only play sound and show notification if message is from someone else
                else if(data.user !== username) {
                    playNotificationSound();
                    showDesktopNotification(data.user, data.msg);
                }
                
                // Send read receipt
                socket.emit('message read');
            });
            
            // Message read receipt
            socket.on('message read', function(data){
                console.log(data.user + " read the messages");
            });
            
            // Click username to mention
            $(document).on('click', '.user-item', function(){
                var mentionUser = $(this).data('username');
                if(mentionUser !== username) {
                    var currentMsg = $message.val();
                    $message.val(currentMsg + '@' + mentionUser + ' ');
                    $message.focus();
                }
            });
            
            // Helper Functions
            function scrollToBottom(){
                $chat.scrollTop($chat[0].scrollHeight);
            }
            
            function playNotificationSound(){
                var audio = document.getElementById('notification-sound');
                audio.play().catch(function(error){
                    console.log("Audio play failed:", error);
                });
            }
            
            function showDesktopNotification(title, body){
                if ("Notification" in window && Notification.permission === "granted") {
                    new Notification(title, {
                        body: body,
                        icon: "https://cdn-icons-png.flaticon.com/512/134/134718.png",
                        badge: "https://cdn-icons-png.flaticon.com/512/134/134718.png"
                    });
                }
            }
            
            function showNotificationBadge(message, type){
                var color = type === "success" ? "#28a745" : type === "info" ? "#17a2b8" : "#ffc107";
                var badge = $('<div class="notification-badge" style="background-color:' + color + '">' + message + '</div>');
                $('body').append(badge);
                setTimeout(function(){
                    badge.fadeOut(function(){
                        badge.remove();
                    });
                }, 3000);
            }
            
            // Highlight mentions in messages
            function highlightMentions(text){
                return text.replace(/@(\w+)/g, '<span class="mention">@$1</span>');
            }
            
            // Focus on message input
            $message.focus();
        });
    </script>
</body>
</html>